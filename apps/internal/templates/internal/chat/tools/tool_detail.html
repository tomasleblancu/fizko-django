{% extends 'internal/chat/base.html' %}
{% load internal_extras %}

{% block page_title %}{{ tool.display_name }}{% endblock %}

{% block page_subtitle %}
<p class="text-muted mb-0">{{ tool.category.name }} - {{ tool.description|truncatewords:15 }}</p>
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'internal:chat:tools_library' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>
        Volver a Biblioteca
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Tool Overview -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Información General
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Detalles Básicos</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Nombre:</strong></td>
                                <td>{{ tool.display_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Nombre Técnico:</strong></td>
                                <td><code>{{ tool.name }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Categoría:</strong></td>
                                <td>
                                    <span class="badge" style="background-color: {{ tool.category.color }};">
                                        <i class="fas fa-{{ tool.category.icon }} me-1"></i>
                                        {{ tool.category.name }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Tipo:</strong></td>
                                <td>
                                    <span class="badge bg-primary">{{ tool.get_tool_type_display }}</span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Estado:</strong></td>
                                <td>
                                    <span class="badge bg-{% if tool.is_active %}success{% else %}secondary{% endif %}">
                                        {% if tool.is_active %}Activa{% else %}Inactiva{% endif %}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Configuración</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Requiere Autenticación:</strong></td>
                                <td>
                                    {% if tool.requires_authentication %}
                                        <i class="fas fa-check text-success"></i> Sí
                                    {% else %}
                                        <i class="fas fa-times text-danger"></i> No
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Limitado por Empresa:</strong></td>
                                <td>
                                    {% if tool.company_scope %}
                                        <i class="fas fa-check text-success"></i> Sí
                                    {% else %}
                                        <i class="fas fa-times text-danger"></i> No
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Máx. Llamadas/Sesión:</strong></td>
                                <td>{{ tool.max_calls_per_session }}</td>
                            </tr>
                            <tr>
                                <td><strong>Veces Utilizada:</strong></td>
                                <td>{{ tool.usage_count }}</td>
                            </tr>
                            {% if tool.last_used_at %}
                            <tr>
                                <td><strong>Último Uso:</strong></td>
                                <td>{{ tool.last_used_at|timesince }} ago</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>

                <div class="mt-3">
                    <h6 class="text-muted">Descripción</h6>
                    <p class="text-muted">{{ tool.description }}</p>
                </div>

                {% if tool.function_path %}
                <div class="mt-3">
                    <h6 class="text-muted">Función</h6>
                    <code class="text-muted">{{ tool.function_path }}</code>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Parameters Schema -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Parámetros
                </h5>
            </div>
            <div class="card-body">
                {% if tool.parameters_schema %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Parámetros Requeridos</h6>
                            {% if tool.required_parameters %}
                                <div class="list-group list-group-flush">
                                    {% for param in tool.required_parameters %}
                                    <div class="list-group-item px-0 py-2">
                                        <div class="d-flex justify-content-between">
                                            <strong>{{ param }}</strong>
                                            {% if param in tool.parameters_schema %}
                                            <span class="badge bg-info">
                                                {{ tool.parameters_schema|lookup:param|lookup:'type'|default:'string' }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        {% if param in tool.parameters_schema and tool.parameters_schema|lookup:param|lookup:'description' %}
                                        <small class="text-muted">
                                            {{ tool.parameters_schema|lookup:param|lookup:'description' }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">Sin parámetros requeridos</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Parámetros Opcionales</h6>
                            {% for param, config in tool.parameters_schema.items %}
                                {% if param not in tool.required_parameters %}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <strong>{{ param }}</strong>
                                        <span class="badge bg-secondary">
                                            {{ config.type|default:'string' }}
                                        </span>
                                    </div>
                                    {% if config.description %}
                                    <small class="text-muted">{{ config.description }}</small>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% empty %}
                                <p class="text-muted">Sin parámetros opcionales</p>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-cogs fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Sin esquema de parámetros definido</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Usage Examples -->
        {% if tool.usage_examples %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-code me-2"></i>
                    Ejemplos de Uso
                </h5>
            </div>
            <div class="card-body">
                {% for example in tool.usage_examples %}
                <div class="mb-3">
                    <h6>{{ example.title|default:"Ejemplo" }}</h6>
                    {% if example.description %}
                    <p class="text-muted small">{{ example.description }}</p>
                    {% endif %}
                    <pre class="bg-light p-3 rounded"><code>{{ example.parameters|pprint }}</code></pre>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Quick Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Estadísticas
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary">{{ tool.usage_count }}</h4>
                            <small class="text-muted">Usos Totales</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info">{{ assigned_agents_count|default:0 }}</h4>
                        <small class="text-muted">Agentes Asignados</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assigned Agents -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>
                    Agentes que la Usan
                </h6>
            </div>
            <div class="card-body">
                {% if assigned_agents %}
                    <div class="list-group list-group-flush">
                        {% for assignment in assigned_agents %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                            <div>
                                <small class="fw-bold">{{ assignment.agent_config.name }}</small>
                                <br>
                                <small class="text-muted">{{ assignment.agent_config.get_agent_type_display }}</small>
                            </div>
                            <div>
                                {% if assignment.is_enabled %}
                                <i class="fas fa-check-circle text-success"></i>
                                {% else %}
                                <i class="fas fa-pause-circle text-warning"></i>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-robot fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Sin agentes asignados</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Tool Category Info -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-tag me-2"></i>
                    Categoría
                </h6>
            </div>
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-{{ tool.category.icon }} fa-3x" style="color: {{ tool.category.color }};"></i>
                </div>
                <h6>{{ tool.category.name }}</h6>
                <p class="text-muted small">{{ tool.category.description }}</p>
                <small class="text-muted">
                    {{ tool.category.tools_count }} herramienta{{ tool.category.tools_count|pluralize }} en esta categoría
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}