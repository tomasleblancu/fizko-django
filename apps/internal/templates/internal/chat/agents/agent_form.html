{% extends 'internal/chat/base.html' %}

{% block page_title %}{{ title }}{% endblock %}

{% block page_subtitle %}
{% if agent %}
<p class="text-muted mb-0">Modifica la configuración del agente</p>
{% else %}
<p class="text-muted mb-0">Configura un nuevo agente de inteligencia artificial</p>
{% endif %}
{% endblock %}

{% block page_actions %}
<a href="{% url 'internal:chat:agent_list' %}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>
    Volver a Lista
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>
                    {{ title }}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}

                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Información Básica
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    Nombre del Agente
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.agent_type.id_for_label }}" class="form-label">
                                    Tipo de Agente
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.agent_type }}
                                {% if form.agent_type.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.agent_type.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    Descripción
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.description.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Describe el propósito y funcionalidad de este agente
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    Estado
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.status.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Model Configuration -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-brain me-2"></i>
                                Configuración del Modelo
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.model_name.id_for_label }}" class="form-label">
                                    Modelo de IA
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.model_name }}
                                {% if form.model_name.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.model_name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.temperature.id_for_label }}" class="form-label">
                                    Temperatura
                                </label>
                                {{ form.temperature }}
                                {% if form.temperature.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.temperature.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">0.0 - 2.0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.max_tokens.id_for_label }}" class="form-label">
                                    Máx. Tokens
                                </label>
                                {{ form.max_tokens }}
                                {% if form.max_tokens.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.max_tokens.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Prompts Configuration -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-comments me-2"></i>
                                Configuración de Prompts
                            </h6>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.system_prompt.id_for_label }}" class="form-label">
                                    Prompt del Sistema
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group-text-wrapper">
                                    {{ form.system_prompt }}
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="enhanceSystemPromptBtn" disabled>
                                        <i class="fas fa-magic me-1"></i>
                                        Mejorar con IA
                                    </button>
                                </div>
                                {% if form.system_prompt.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.system_prompt.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Instrucciones principales que definen el comportamiento del agente. Escribe tu prompt y usa "Mejorar con IA" para optimizarlo.
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.context_instructions.id_for_label }}" class="form-label">
                                    Instrucciones de Contexto
                                </label>
                                <div class="input-group-text-wrapper">
                                    {{ form.context_instructions }}
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="enhanceContextInstructionsBtn" disabled>
                                        <i class="fas fa-magic me-1"></i>
                                        Mejorar con IA
                                    </button>
                                </div>
                                {% if form.context_instructions.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.context_instructions.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Instrucciones específicas sobre el contexto y situación. Escribe tus instrucciones y usa "Mejorar con IA" para optimizarlas.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>
                                        {% if agent %}Actualizar Agente{% else %}Crear Agente{% endif %}
                                    </button>
                                    <a href="{% url 'internal:chat:agent_list' %}" class="btn btn-outline-secondary ms-2">
                                        <i class="fas fa-times me-2"></i>
                                        Cancelar
                                    </a>
                                </div>
                                {% if agent %}
                                <div>
                                    <a href="{% url 'internal:chat:agent_detail' agent.id %}" class="btn btn-outline-info">
                                        <i class="fas fa-eye me-2"></i>
                                        Ver Detalle
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Consejos de Configuración
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Nombre:</strong> Usa nombres descriptivos como "Agente SII FAQ" o "Asistente Documentos"
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Temperatura:</strong> Valores bajos (0.1-0.3) para respuestas precisas, altos (0.7-1.0) para creatividad
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Prompt del Sistema:</strong> Define claramente el rol y comportamiento esperado del agente
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Tipo:</strong> Selecciona el tipo según las herramientas que necesite usar
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const systemPromptTextarea = document.getElementById('{{ form.system_prompt.id_for_label }}');
    const contextInstructionsTextarea = document.getElementById('{{ form.context_instructions.id_for_label }}');
    const enhanceSystemPromptBtn = document.getElementById('enhanceSystemPromptBtn');
    const enhanceContextInstructionsBtn = document.getElementById('enhanceContextInstructionsBtn');
    const agentTypeSelect = document.getElementById('{{ form.agent_type.id_for_label }}');

    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Function to check if enhancement button should be enabled
    function updateEnhanceButton(textarea, button) {
        if (textarea && button) {
            const hasContent = textarea.value.trim().length > 10;
            const hasAgentType = agentTypeSelect.value !== '';
            button.disabled = !(hasContent && hasAgentType);
        }
    }

    // Function to enhance content
    function enhanceContent(textarea, button, promptType) {
        const content = textarea.value.trim();
        const agentType = agentTypeSelect.value;
        const agentName = document.getElementById('{{ form.name.id_for_label }}').value || 'Nuevo Agente';
        const agentDescription = document.getElementById('{{ form.description.id_for_label }}').value || '';

        if (!content || !agentType) {
            alert('Por favor completa el contenido y selecciona el tipo de agente antes de mejorar.');
            return;
        }

        // Show loading state
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Mejorando...';
        button.disabled = true;

        // Prepare context
        const context = {
            agent_name: agentName,
            agent_description: agentDescription
        };

        // Make API call
        fetch('{% url "internal:chat:enhance_prompt_standalone_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                content: content,
                prompt_type: promptType,
                agent_type: agentType,
                context: context
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Replace textarea content with enhanced version
                textarea.value = data.enhanced_content;

                // Auto-resize textarea
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';

                // Show success message
                showToast('¡Contenido mejorado exitosamente!', 'success');
            } else {
                showToast(data.error || 'Error al mejorar el contenido', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error de conexión al mejorar el contenido', 'error');
        })
        .finally(() => {
            button.innerHTML = originalText;
            updateEnhanceButton(textarea, button);
        });
    }

    // Function to show toast notifications
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        const toast = document.createElement('div');
        const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';

        toast.className = `toast align-items-center text-white ${bgClass} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
        bsToast.show();

        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }

    // Function to create toast container
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1055';
        document.body.appendChild(container);
        return container;
    }

    // Event listeners for content changes
    if (systemPromptTextarea) {
        systemPromptTextarea.addEventListener('input', function() {
            updateEnhanceButton(this, enhanceSystemPromptBtn);
            // Auto-resize
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }

    if (contextInstructionsTextarea) {
        contextInstructionsTextarea.addEventListener('input', function() {
            updateEnhanceButton(this, enhanceContextInstructionsBtn);
            // Auto-resize
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }

    if (agentTypeSelect) {
        agentTypeSelect.addEventListener('change', function() {
            updateEnhanceButton(systemPromptTextarea, enhanceSystemPromptBtn);
            updateEnhanceButton(contextInstructionsTextarea, enhanceContextInstructionsBtn);
        });
    }

    // Event listeners for enhance buttons
    if (enhanceSystemPromptBtn) {
        enhanceSystemPromptBtn.addEventListener('click', function() {
            enhanceContent(systemPromptTextarea, this, 'system_prompt');
        });
    }

    if (enhanceContextInstructionsBtn) {
        enhanceContextInstructionsBtn.addEventListener('click', function() {
            enhanceContent(contextInstructionsTextarea, this, 'context_instructions');
        });
    }

    // Initial check for button states
    updateEnhanceButton(systemPromptTextarea, enhanceSystemPromptBtn);
    updateEnhanceButton(contextInstructionsTextarea, enhanceContextInstructionsBtn);

    // Auto-resize textareas on page load
    const textareas = [systemPromptTextarea, contextInstructionsTextarea].filter(Boolean);
    textareas.forEach(textarea => {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    });
});
</script>
{% endblock %}